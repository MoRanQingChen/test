<!DOCTYPE html>
<html lang="zh">

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0">
  <title>音乐の恋爱秘语</title>
  <link rel="apple-touch-icon" href="icon.png">
  <link href="https://fonts.cat.net/css?family=Quicksand:400" rel="stylesheet">
  <link charset="UTF-8" href="shared/sp/css/common.css" rel="stylesheet">
  <link charset="utf-8" href="css/mikutap.css" rel="stylesheet">
  <script charset="utf-8" src="https://cdnjs.cat.net/ajax/libs/jquery/2.2.4/jquery.min.js" type="text/javascript"></script>
  <script charset="utf-8" src="https://cdnjs.cat.net/ajax/libs/pixi.js/3.0.11/pixi.min.js" type="text/javascript"></script>
  <script charset="utf-8" src="https://cdnjs.cat.net/ajax/libs/gsap/1.19.1/TweenMax.min.js" type="text/javascript"></script>
  <script charset="UTF-8" src="shared/js/common-2.min.js" type="text/javascript"></script>
  <script charset="utf-8" src="js/mikutap.min.js" type="text/javascript"></script>
</head>

<body>
  <!-- 资源加载loading -->
  <div id="resloading" style="position:absolute;width:100%;height:100%;z-index: 101;">
      <img src="http://wx2.sinaimg.cn/mw690/675f3c9cgy1fno2lsnrf5j20u01hctb1.jpg" alt="" style="position:absolute;width:100%;height:100%;left:0;top:0">
      <div style="
      position: absolute;
      top: 50%;
      left: 50%;
      margin-top: -126px;
      margin-left: -102px;
      transform: rotate(180deg);
  ">
        <?xml version="1.0"?>
        <svg width="200" height="200">
            <circle cx="100" cy="100" r="77" stroke-width="5" stroke="#C1C1C1" fill="none"></circle>
            <circle cx="340" cy="100" r="77" stroke-width="5" stroke="#FE7DB3" fill="none" transform="matrix(0,-1,1,0,0,440)" stroke-dasharray="0 1069"></circle>
            <circle cx="340" cy="100" r="77" stroke-width="7" stroke="#FDFCFA" fill="none" transform="matrix(0,-1,1,0,0,440)" stroke-dasharray="10.3 15"></circle>
        </svg>
      </div>
      <div class="mask" onclick="$('#resloading').fadeOut(400, 'linear');$('#startphone').fadeIn(400, 'linear');$('#audio')[0].play()"></div>
      <div class="print">资源加载调试输出：<br></div>
  </div>
  <!-- 电话层 -->
  <div id="startphone" style="position:absolute;width:100%;height:100%;z-index: 99;background-size: 100% 100%;display:none">
    <audio id="audio" src="http://dx.sc.chinaz.com/Files/DownLoad/sound1/201703/8521.mp3" loop="loop" preload="auto"></audio>
    <audio id="audioClose" src="http://zjdx1.sc.chinaz.com/Files/DownLoad/sound1/201501/5351.mp3" preload="auto"></audio>
    <div class="playvideo" onclick="$('#startphone').fadeOut(400, 'linear');$('#video').show();$('#audio')[0].pause();$('#my_video')[0].play()" style="width: 18%;height: 10%;position:absolute;top: 77%;left: 16%;font-size:0;z-index:100">单身</div>
    <div class="startGame" onclick="$('#audioClose')[0].play();setTimeout(function(){$('#startphone').fadeOut(400, 'linear');$('#startgame').fadeIn(400, 'linear')},800);$('#video').hide();$('#audio')[0].pause();" style="width: 18%;height: 10%;position:absolute;top: 77%;left: 66%;font-size:0;z-index:100">恋爱</div>
  </div>
  <!-- 视频层 -->
  <div id="video" class="video " style="width: 100%; height: 100%;position:absolute;z-index:98;display:none">
      <video id="my_video" style="object-fit: fill; width: 100%; height: 100%;"
          preload="load"
          playsinline="true"
          webkit-playsinline="true"
          x-webkit-airplay="allow"
          airplay="allow"
          x5-video-player-type="h5"
          x5-video-player-fullscreen="true"
          x5-video-orientation="portrait"
          src="http://static.s3.huajiao.com/Object.access/hj-video/MzUzMTE4MDUxNTE2MTAzNDEyMjQ4Mjc5NTc4NTc0NC5tcDQ="
      ></video>
      <div 
        style="position: absolute;bottom: 13%;width: 18%;height: 10%;background: red;z-index: 99999;left: 41%;border-radius: 100%;"
        onclick="$('#audioClose')[0].play();setTimeout(function(){$('#video').fadeOut(400, 'linear');$('#startgame').fadeIn(400, 'linear')},800);document.getElementById('my_video').pause()"
      >挂断</div>
  </div>
  <div id="view"></div>
  <!-- 提示层 -->
  <div id="scene_top">
    <div id="ng">
      <p class="atten">十分抱歉<br>您的浏览器并不支持本页面需要的特性</p>
    </div>
    <div class="ok">
      <!-- <p id="bt_start"><a href="">!开始!</a></p> -->
    </div>
  </div>
  <div id="scene_loading">
    <hr size="1" color="#fff"> 
  </div>
  <!-- 游戏开始前 -->
  <div id="startgame" style="position:absolute;width:100%;height:100%;z-index: 97;display: none;">
    <div class="start ds" style="width: 25%;height: 5%;position:absolute;top: 82%;left: 20%;font-size:0">单身</div>
    <div class="start la" style="width: 25%;height: 5%;position:absolute;top: 82%;left: 55%;font-size:0">恋爱</div>
  </div>
  <!-- 游戏结束层 -->
  <div id="endgame" style="position:absolute;width:100%;height:100%;background: url(http://wx3.sinaimg.cn/mw690/675f3c9cgy1fnma8o5ek6j20kz10u419.jpg);z-index: 96;background-size: 100% 100%;display: none;color:red;text-align:left;">
    <div class="start ds" style="width: 25%;height: 5%;position:absolute;top: 82%;left: 20%;"></div>
    <div class="start la" style="width: 25%;height: 5%;position:absolute;top: 82%;left: 55%;"></div>
  </div>
  <!-- 提示层 -->
  <div id="scene_main">
    <div class="set">
      <p class="attention" style="color:#000">点击 &amp; 拖动或者按任意键!</p>
      <p id="bt_backtrack"><a href="" style="color:#000">背景音乐: 开启</a></p>
    </div>
  </div>
  <div id="about_cover"></div>
<script>
  $().ready(function(){
/** 
 * 资源包含
 * 
 * 电话层、游戏开始层、游戏结束层、视频、游戏素材
*/
    var loadingCount = 0
    var loadVideo = 0;//视频加载次数
    var imgObj = {
      startphone:"http://wx2.sinaimg.cn/mw690/675f3c9cgy1fnn0dxr0pvj20ky0zf0wr.jpg",
      startgame:"http://wx1.sinaimg.cn/mw690/675f3c9cgy1fnma8nm68fj20kx117tbg.jpg",
    }
    for(var key in imgObj){
      (function(key){
        var temp = new Image()
        temp.src = imgObj[key]
        temp.onload = function(){
          $(".print").html($(".print").html()+key+"图片资源加载完成<br>");
          loadingCount +=2;
          check_loading();
          ;(!/^\d+$/.test(key))&&$('#'+key).css({background:"url("+imgObj[key]+")",backgroundSize:"100% 100%"})
        }
      })(key)
    }
    
    document.getElementById("my_video").addEventListener("ended",function(){
      $('#video').fadeOut(400, 'linear');$('#startgame').fadeIn(400, 'linear')
    })
    var audio = document.getElementById("audio");  
    var video = $("#my_video")[0];
      audio.play();  
      video.load()  
      audio.pause();
    document.addEventListener("WeixinJSBridgeReady", function () {  
      audio.play();  
      video.load()
      audio.pause();
    }, false);  
    document.addEventListener('YixinJSBridgeReady', function() {  
      audio.play();  
      video.load()  
      audio.pause();
    }, false);  
    
    var buffered_end= 0;
    var buffered_count = 0;
    var t2 = window.setInterval(function() {
      try{
        if(video.buffered.end(0) == buffered_end){
          if(buffered_count ++>10){
            $(".print").html($(".print").html()+"视频缓冲区停止缓存");
            loadingCount =9;
            check_loading()
            clearInterval(t2)
          }
        }else{
          buffered_end = video.buffered.end(0);
          buffered_count = 0;
          $(".print").html($(".print").html().replace(/<span>.*<\/span>/,"<span>"+video.buffered.end(0).toFixed(2)+"</span>"));
          if(video.buffered.end(0)>10){
            loadingCount =7;
            check_loading()
          }else if(video.buffered.end(0)>15){
            loadingCount =8;
            check_loading()
          }
        }
      }catch(e){
        // alert(e)
      }
    },100);

    function check_loading(){
      circle = document.querySelectorAll("circle")[1]
      var percent = loadingCount / 9, perimeter = Math.PI * 2 * 77;
      circle.setAttribute('stroke-dasharray', perimeter * percent + " " + perimeter * (1- percent));
      loadingCount == 4&&$(".print").html($(".print").html()+"视频缓冲内容<span>0.00</span>秒<br>");
      setTimeout(function(){
        if(loadingCount>=9){
          $('#resloading').fadeOut(400, 'linear');$('#startphone').fadeIn(400, 'linear');
          audio.play();
        }
      },500)
    }
  })
</script>
</body>
</html>
